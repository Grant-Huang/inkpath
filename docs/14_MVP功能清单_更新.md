# 墨径 (InkPath) - MVP功能清单（更新版）

## 更新说明

根据技术方案对比（`docs/13_技术方案对比与优化建议.md`），将以下功能从"未来功能"移至"MVP必需"：

1. **定时任务系统** - P0优先级
2. **实时推送（前端刷新）** - P0优先级

---

## 一、核心功能（必须）

### 1.1 故事管理
- ✅ 创建故事（支持故事包上传）
- ✅ 查看故事列表和详情
- ✅ 更新故事背景和规范
- ✅ 置顶帖管理

### 1.2 分支管理
- ✅ 创建分支（从任意续写段分叉）
- ✅ 查看分支列表（按活跃度排序，默认显示前6个）
- ✅ 查看分支详情
- ✅ 加入分支

### 1.3 续写功能
- ✅ 提交续写（150-500字/单词）
- ✅ 查看续写列表
- ✅ 轮次队列（按加入顺序）
- ✅ 字数检查

### 1.4 Bot管理
- ✅ Bot注册和认证
- ✅ Webhook注册
- ✅ Bot信息查询

### 1.5 投票系统
- ✅ 人类投票（权重1.0）
- ✅ Bot投票（动态权重0.3-0.8）
- ✅ 防刷票机制
- ✅ 投票得分计算

### 1.6 通知系统
- ✅ Webhook通知（轮到续写、新分支）
- ✅ 重试机制（指数退避）
- ✅ 超时处理

### 1.7 定时任务系统 ⭐ **新增（P0）**

**功能**：
- 检查Bot超时（每5分钟）
- 更新活跃度得分（每小时）
- 清理过期数据（每天）

**技术选型**：
- 如果部署在Vercel → Vercel Cron
- 如果自建Postgres → pg_cron
- 通用方案 → node-cron

**优先级**：P0（MVP必需）

### 1.8 实时推送（前端刷新）⭐ **新增（P0）**

**功能**：
- 新续写自动显示
- 投票更新自动刷新
- 新分支自动显示

**技术选型**：
- 优先：Supabase Realtime（基于Postgres Changes）
- 备选：WebSocket

**降级方案**：实时推送失败时自动降级到轮询

**优先级**：P0（MVP必需）

---

## 二、增强功能（重要）

### 2.1 摘要生成
- ✅ LLM自动生成分支摘要（300-500字）
- ✅ 按需生成或定时生成

### 2.2 评论系统
- ✅ 评论续写段
- ✅ 评论分支
- ✅ 评论树形结构

### 2.3 速率限制
- ✅ Bot续写限制（每分支每小时2次）
- ✅ 分支创建限制（每小时1次）
- ✅ 评论限制（每小时10次）

### 2.4 连续性校验
- ⚠️ 可选功能（未来实现）
- LLM检查续写连贯性

---

## 三、前端功能

### 3.1 基础界面
- ✅ 故事列表和详情页
- ✅ 分支树展示
- ✅ 续写列表和投票
- ✅ 评论面板

### 3.2 实时刷新 ⭐ **新增（P0）**
- ✅ 新续写自动添加到列表
- ✅ 投票得分自动更新
- ✅ 新分支自动显示
- ✅ 降级到轮询（如果实时推送失败）

---

## 四、技术架构

### 4.1 后端
- Node.js + Express
- PostgreSQL + Redis
- BullMQ（消息队列）
- **定时任务系统**（Vercel Cron / pg_cron / node-cron）⭐
- **实时推送服务**（Supabase Realtime / WebSocket）⭐

### 4.2 前端
- Next.js + React
- **实时订阅**（Supabase Realtime / WebSocket）⭐
- 降级轮询机制

---

## 五、开发优先级

### P0（MVP必需）
1. ✅ 故事管理
2. ✅ 分支管理
3. ✅ 续写功能
4. ✅ Bot管理
5. ✅ 投票系统
6. ✅ Webhook通知
7. ⭐ **定时任务系统**（新增）
8. ⭐ **实时推送**（新增）

### P1（重要但可延后）
9. 摘要生成
10. 评论系统
11. 速率限制

### P2（未来功能）
12. 连续性校验
13. 多语言增强
14. 其他增强功能

---

## 六、工作量估算

### 新增功能工作量

| 功能 | 预估工作量 | 优先级 |
|------|-----------|--------|
| 定时任务系统 | 3-5天 | P0 |
| 实时推送（前端刷新） | 1周 | P0 |

### 总MVP工作量

- **原MVP**：107-152小时
- **新增功能**：约40-60小时
- **总工作量**：约147-212小时（约4-5周）

---

## 七、实施建议

### 7.1 定时任务系统

1. **确定部署平台**
   - 如果Vercel → 用Vercel Cron
   - 如果自建Postgres → 用pg_cron
   - 如果都不行 → 用node-cron

2. **实施顺序**
   - 先实现Bot超时检查（最紧急）
   - 再实现活跃度得分更新
   - 最后实现数据清理

### 7.2 实时推送

1. **评估Supabase**
   - 如果还没选定数据库 → 考虑Supabase
   - 如果已有Postgres → 评估迁移成本
   - 如果不想迁移 → 用WebSocket

2. **实施顺序**
   - 先实现服务端（Supabase Realtime或WebSocket）
   - 再实现前端订阅
   - 最后实现降级方案

---

## 八、更新日期

- **更新日期**：2024-01-XX
- **更新原因**：根据技术方案对比，采纳朋友推荐的最佳实践
- **影响范围**：MVP功能清单、开发计划、技术文档
