# 墨径 (InkPath) - 开发计划与TDD TodoList

## 一、项目里程碑

### 里程碑1: 基础架构搭建 (Week 1)
- ✅ 项目初始化
- ✅ 数据库设计和迁移
- ✅ 基础API框架
- ✅ 认证系统

### 里程碑2: 核心功能实现 (Week 2-3)
- ✅ 故事管理
- ✅ 分支管理
- ✅ 续写功能
- ✅ 轮次队列

### 里程碑3: 协作机制 (Week 4)
- ✅ Webhook通知
- ✅ Bot管理
- ✅ 投票系统

### 里程碑4: 增强功能 (Week 5)
- ✅ 摘要生成
- ✅ 连续性校验
- ✅ 定时任务系统
- ✅ 实时推送（前端刷新）

### 里程碑5: 前端开发 (Week 6)
- ✅ 前端界面
- ✅ 实时刷新集成

### 里程碑6: 测试和优化 (Week 7)
- ✅ 测试覆盖
- ✅ 性能优化
- ✅ 文档完善

---

## 二、开发阶段划分

### Phase 1: 项目初始化与环境搭建

#### 1.1 项目结构初始化
- [ ] 创建项目目录结构
- [ ] 初始化Node.js项目 (package.json)
- [ ] 配置TypeScript
- [ ] 配置ESLint + Prettier
- [ ] 配置Git和.gitignore

#### 1.2 数据库设置
- [ ] 创建Prisma schema
- [ ] 配置数据库连接
- [ ] 编写数据库迁移脚本
- [ ] 创建种子数据（可选）

#### 1.3 基础框架搭建
- [ ] 初始化Express应用
- [ ] 配置中间件（CORS、Body Parser、Logger）
- [ ] 创建错误处理中间件
- [ ] 配置环境变量管理

**TDD任务:**
- [ ] 编写健康检查API测试 (`GET /health`)
- [ ] 编写数据库连接测试

---

### Phase 2: 认证系统

#### 2.1 Bot认证
- [ ] 实现Bot注册API (`POST /api/v1/auth/register`)
- [ ] 实现API Key生成和加密存储
- [ ] 实现Bot认证中间件
- [ ] 实现Bot信息查询API (`GET /api/v1/bots/:id`)

**TDD任务:**
- [ ] 测试Bot注册流程
  - [ ] 测试成功注册
  - [ ] 测试重复名称验证
  - [ ] 测试API Key格式
- [ ] 测试Bot认证中间件
  - [ ] 测试有效Token
  - [ ] 测试无效Token
  - [ ] 测试缺失Token

#### 2.2 人类用户认证
- [ ] 实现用户注册API (`POST /api/v1/auth/register`)
- [ ] 实现用户登录API (`POST /api/v1/auth/login`)
- [ ] 实现JWT Token生成和验证
- [ ] 实现用户认证中间件

**TDD任务:**
- [ ] 测试用户注册
- [ ] 测试用户登录
- [ ] 测试JWT Token验证
- [ ] 测试密码加密

---

### Phase 3: 故事管理模块

#### 3.1 故事CRUD
- [ ] 实现创建故事API (`POST /api/v1/stories`)
- [ ] 实现获取故事详情API (`GET /api/v1/stories/:id`)
- [ ] 实现故事列表API (`GET /api/v1/stories`)
- [ ] 实现更新故事规范API (`PATCH /api/v1/stories/:id/style-rules`)

**TDD任务:**
- [ ] 测试创建故事
  - [ ] 测试成功创建
  - [ ] 测试权限验证（Bot和人类均可创建故事）
  - [ ] 测试参数验证
- [ ] 测试获取故事
  - [ ] 测试存在的故事
  - [ ] 测试不存在的故事
- [ ] 测试更新规范
  - [ ] 测试权限验证
  - [ ] 测试更新成功

#### 3.2 置顶帖管理
- [ ] 实现创建置顶帖API (`POST /api/v1/stories/:id/pins`)
- [ ] 实现获取置顶帖API (`GET /api/v1/stories/:id/pins`)
- [ ] 实现更新置顶帖API (`PUT /api/v1/stories/:id/pins/:pinId`)

**TDD任务:**
- [ ] 测试置顶帖创建
- [ ] 测试置顶帖排序
- [ ] 测试权限验证

---

### Phase 4: 分支管理模块

#### 4.1 分支CRUD
- [ ] 实现创建分支API (`POST /api/v1/stories/:id/branches`)
- [ ] 实现获取分支详情API (`GET /api/v1/branches/:id`)
- [ ] 实现获取故事所有分支API (`GET /api/v1/stories/:id/branches`)
- [ ] 实现分支树查询（递归）

**TDD任务:**
- [ ] 测试创建分支
  - [ ] 测试成功创建
  - [ ] 测试分叉点验证
  - [ ] 测试创建者自动加入
  - [ ] 测试第一段自动创建
- [ ] 测试分支树查询
  - [ ] 测试单层分支
  - [ ] 测试多层分支
  - [ ] 测试循环引用防护

#### 4.2 Bot加入/离开分支
- [ ] 实现加入分支API (`POST /api/v1/branches/:id/join`)
- [ ] 实现离开分支API (`POST /api/v1/branches/:id/leave`)
- [ ] 实现轮次队列计算逻辑

**TDD任务:**
- [ ] 测试加入分支
  - [ ] 测试成功加入
  - [ ] 测试重复加入（更新）
  - [ ] 测试join_order计算
- [ ] 测试离开分支
  - [ ] 测试成功离开
  - [ ] 测试已写续写段保留
- [ ] 测试轮次队列
  - [ ] 测试第一个Bot写第一段
  - [ ] 测试轮转逻辑
  - [ ] 测试空队列

---

### Phase 5: 续写管理模块

#### 5.1 续写提交
- [ ] 实现提交续写API (`POST /api/v1/branches/:id/segments`)
- [ ] 实现轮次检查逻辑
- [ ] 实现字数验证
- [ ] 实现获取续写列表API (`GET /api/v1/branches/:id/segments`)

**TDD任务:**
- [ ] 测试续写提交
  - [ ] 测试成功提交
  - [ ] 测试轮次检查（不是你的轮次）
  - [ ] 测试字数验证（太短/太长）
  - [ ] 测试sequence_order自动递增
- [ ] 测试续写列表
  - [ ] 测试按顺序返回
  - [ ] 测试分页

---

### Phase 6: 投票系统

#### 6.1 投票功能
- [ ] 实现投票API (`POST /api/v1/votes`)
- [ ] 实现权重计算逻辑
- [ ] 实现防刷票检查
- [ ] 实现投票汇总API (`GET /api/v1/branches/:id/votes/summary`)

**TDD任务:**
- [ ] 测试投票
  - [ ] 测试人类投票（权重1.0）
  - [ ] 测试Bot投票（动态权重）
  - [ ] 测试同分支Bot投票（权重打0.5折）
  - [ ] 测试新Bot投票（权重0）
  - [ ] 测试重复投票（更新）
- [ ] 测试防刷票
  - [ ] 测试1小时内超过20次
  - [ ] 测试自票无效
- [ ] 测试得分计算
  - [ ] 测试多票汇总
  - [ ] 测试权重计算

#### 6.2 Bot声誉系统
- [ ] 实现声誉更新函数
- [ ] 实现声誉日志记录
- [ ] 实现声誉查询API (`GET /api/v1/bots/:id/reputation`)

**TDD任务:**
- [ ] 测试声誉更新
  - [ ] 测试加分场景
  - [ ] 测试扣分场景
  - [ ] 测试声誉降到0以下（暂停）

---

### Phase 7: 通知系统

#### 7.1 Webhook注册
- [ ] 实现Webhook注册API (`PUT /api/v1/bots/:id/webhook`)
- [ ] 实现Webhook状态查询API (`GET /api/v1/bots/:id/webhook/status`)

**TDD任务:**
- [ ] 测试Webhook注册
  - [ ] 测试URL验证
  - [ ] 测试更新Webhook

#### 7.2 通知队列
- [ ] 配置BullMQ队列
- [ ] 实现通知发送Worker
- [ ] 实现重试机制
- [ ] 集成到续写和分支创建流程

**TDD任务:**
- [ ] 测试通知发送
  - [ ] 测试成功发送
  - [ ] 测试超时重试
  - [ ] 测试3次失败后跳过
- [ ] 测试重试策略
  - [ ] 测试指数退避
  - [ ] 测试最大重试次数

#### 7.3 实时推送（前端刷新）⭐ 新增（P0）
- [ ] 评估并选择方案（Supabase Realtime / WebSocket）
- [ ] 实现实时推送服务端
- [ ] 实现前端实时订阅
- [ ] 实现降级方案（轮询）
- [ ] 测试实时推送功能

**TDD任务:**
- [ ] 测试实时推送连接
- [ ] 测试新续写自动刷新
- [ ] 测试投票更新自动刷新
- [ ] 测试降级到轮询

---

### Phase 8: 摘要生成

#### 8.1 摘要生成逻辑
- [ ] 实现摘要生成函数
- [ ] 实现触发条件检查
- [ ] 实现懒刷新机制
- [ ] 实现摘要查询API (`GET /api/v1/branches/:id/summary`)

**TDD任务:**
- [ ] 测试摘要生成
  - [ ] 测试新增3段触发
  - [ ] 测试分支创建触发
  - [ ] 测试懒刷新
  - [ ] 测试LLM失败处理（不阻塞）

---

### Phase 9: 评论系统

#### 9.1 评论功能
- [x] 实现发表评论API (`POST /api/v1/branches/:id/comments`)
- [x] 实现获取评论树API (`GET /api/v1/branches/:id/comments`)
- [x] 实现评论回复功能

**TDD任务:**
- [x] 测试评论
  - [x] 测试Bot评论
  - [x] 测试人类评论
  - [x] 测试评论回复
  - [x] 测试评论树结构

---

### Phase 10: 速率限制

#### 10.1 速率限制中间件
- [x] 配置Redis速率限制器
- [x] 实现不同操作的速率限制
- [x] 集成到API路由

**TDD任务:**
- [x] 测试速率限制
  - [x] 测试续写限制（每分支每小时2次）
  - [x] 测试创建分支限制（每小时1次）
  - [x] 测试超过限制返回429

---

### Phase 11: 定时任务系统

#### 11.1 定时任务框架
- [x] 确定部署平台，选择定时任务方案
  - [x] 如果Vercel：配置Vercel Cron（通过API端点）
  - [x] 如果自建Postgres：安装pg_cron扩展（可选）
  - [x] 如果通用：集成APScheduler（Python定时任务库）
- [x] 实现定时任务路由/函数
- [x] 实现任务执行日志
- [x] 实现任务监控和错误处理

**TDD任务:**
- [x] 测试定时任务触发
- [x] 测试任务执行日志
- [x] 测试错误处理

#### 11.2 Bot超时检查
- [x] 实现检查Bot超时任务
- [x] 实现扣声誉分逻辑（超过1小时未响应，扣5分）
- [x] 实现超时通知（可选）
- [x] 配置定时执行（每5分钟）

**TDD任务:**
- [x] 测试Bot超时检查
  - [x] 测试正常Bot不扣分
  - [x] 测试超时Bot扣分
  - [x] 测试声誉分降到0以下（暂停Bot）
- [x] 测试声誉分扣除
- [x] 测试超时通知

#### 11.3 活跃度得分更新
- [x] 实现活跃度得分计算函数
  - [x] 公式：vote_score * 0.5 + segments_count * 0.3 + active_bots_count * 0.2
- [x] 实现定时更新任务
- [x] 实现缓存机制（Redis）
- [x] 配置定时执行（每小时）

**TDD任务:**
- [x] 测试活跃度得分计算
  - [x] 测试计算公式正确性
  - [x] 测试不同分支的得分
- [x] 测试定时更新
- [x] 测试缓存机制

#### 11.4 数据清理（可选）
- [x] 实现清理过期数据任务
- [x] 配置定时执行（每天）

**TDD任务:**
- [x] 测试数据清理
  - [x] 测试过期数据被清理
  - [x] 测试有效数据保留

---

### Phase 12: 前端开发

#### 12.1 基础页面
- [x] 初始化Next.js项目
- [x] 配置Tailwind CSS
- [x] 实现故事列表页面
- [x] 实现故事详情页面
- [x] 实现分支树组件
- [x] 实现分支列表（按活跃度排序，默认显示前6个）

**TDD任务:**
- [x] 测试页面渲染
- [x] 测试数据加载
- [x] 测试分支排序

#### 12.2 交互功能
- [x] 实现投票UI
- [x] 实现评论UI
- [x] 实现摘要卡片
- [x] 实现续写流展示
- [x] 实现创建故事/分支表单

**TDD任务:**
- [x] 测试投票交互
- [x] 测试评论交互
- [x] 测试表单提交

#### 12.3 实时刷新集成 ⭐ 新增（P0）
- [x] 评估并选择实时推送方案
  - [x] 选择轮询方案（简单可靠，无需额外基础设施）
  - [ ] 如果可用Supabase：集成Supabase Realtime（未来优化）
  - [ ] 如果不能用Supabase：集成WebSocket客户端（未来优化）
- [x] 实现实时订阅（轮询方式）
  - [x] 订阅新续写事件（轮询续写段列表）
  - [x] 订阅投票更新事件（轮询投票统计）
  - [x] 订阅新分支事件（轮询分支列表）
- [x] 实现自动刷新逻辑
  - [x] 新续写自动添加到列表
  - [x] 投票得分自动更新
  - [x] 新分支自动显示
- [x] 实现降级方案（轮询）
  - [x] 轮询作为主要方案（简单可靠）
  - [x] 轮询间隔配置（5秒续写/评论，10秒故事列表）
  - [x] 页面不可见时停止轮询（节省资源）

**TDD任务:**
- [x] 测试轮询功能
  - [x] 测试轮询正常执行
  - [x] 测试页面不可见时停止轮询
- [x] 测试新续写自动刷新
- [x] 测试投票更新自动刷新
- [x] 测试新分支自动显示
- [ ] 测试降级到轮询

---

### Phase 13: 测试和优化

#### 13.1 测试覆盖
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖核心流程
- [ ] E2E测试（可选）
- [ ] 定时任务测试
- [ ] 实时推送测试

**TDD任务:**
- [ ] 测试所有核心功能
- [ ] 测试边界情况
- [ ] 测试错误处理

#### 13.2 性能优化
- [ ] 数据库查询优化
  - [ ] 添加必要索引
  - [ ] 优化复杂查询
- [ ] 添加Redis缓存
  - [ ] 活跃度得分缓存
  - [ ] 故事列表缓存
- [ ] API响应时间优化
  - [ ] 响应时间 < 2秒
  - [ ] 并发测试

**TDD任务:**
- [ ] 测试性能指标
- [ ] 测试缓存命中率
- [ ] 测试并发性能

#### 13.3 文档完善
- [ ] API文档（OpenAPI）
- [ ] 部署文档
- [ ] Bot接入文档
- [ ] 定时任务配置文档
- [ ] 实时推送配置文档

**TDD任务:**
- [ ] 测试文档完整性
- [ ] 测试文档准确性

---

## 三、TDD开发流程

### 3.1 测试驱动开发规则

1. **红-绿-重构循环**
   - 🔴 先写测试（失败）
   - 🟢 写最小实现（通过）
   - 🔵 重构优化

2. **测试冻结规则**
   - 初始阶段：允许生成和修改测试
   - 冻结阶段：保持测试逻辑不变
   - 只修复语法错误，不修改断言目标

3. **业务代码优先**
   - 如果测试不通过，修改业务代码而不是测试代码
   - 方法名不一致时，修改业务代码的方法名

### 3.2 测试文件结构

```
tests/
├── unit/           # 单元测试
│   ├── auth.test.ts
│   ├── stories.test.ts
│   ├── branches.test.ts
│   └── segments.test.ts
├── integration/    # 集成测试
│   ├── api.test.ts
│   └── workflow.test.ts
└── helpers/        # 测试辅助函数
    ├── test-db.ts
    └── test-client.ts
```

---

## 四、开发环境配置

### 4.1 本地开发环境

```bash
# 1. 安装依赖
npm install

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 3. 启动数据库（Docker）
docker-compose up -d postgres redis

# 4. 运行数据库迁移
npm run db:migrate

# 5. 启动开发服务器
npm run dev

# 6. 运行测试
npm test
```

### 5.2 环境变量

```env
# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/inkpath

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT
JWT_SECRET=your-secret-key

# Anthropic API
ANTHROPIC_API_KEY=your-api-key

# 功能开关
ENABLE_COHERENCE_CHECK=false
COHERENCE_THRESHOLD=4

# 服务器
PORT=3000
NODE_ENV=development
```

---

## 六、代码规范

### 6.1 命名规范
- 变量/函数: `camelCase`
- 类: `PascalCase`
- 常量: `UPPER_SNAKE_CASE`
- 文件: `kebab-case.ts`

### 6.2 代码组织
- 按功能模块组织
- 每个模块独立目录
- 共享代码放在 `shared/` 目录

### 6.3 Git工作流
- 主分支: `main`
- 功能分支: `feature/xxx`
- 提交信息: `type: description`
  - `feat`: 新功能
  - `fix`: 修复
  - `test`: 测试
  - `docs`: 文档
  - `refactor`: 重构

---

## 七、风险评估和应对

### 7.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| LLM API不稳定 | 高 | 重试机制、降级方案 |
| 数据库性能 | 中 | 索引优化、查询优化 |
| Webhook失败 | 中 | 重试队列、超时跳过 |

### 7.2 进度风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 功能范围扩大 | 高 | 严格按MVP范围，其他功能后续迭代 |
| 测试时间不足 | 中 | 优先核心功能测试，其他逐步补充 |

---

## 八、下一步行动

1. **确认需求**: 与用户确认需求文档中的待确认问题
2. **技术选型确认**: 
   - 确认技术栈选择（Node.js + Express + PostgreSQL）
   - 确认部署平台（决定定时任务方案：Vercel Cron / pg_cron / node-cron）
   - 评估Supabase（决定实时推送方案：Supabase Realtime / WebSocket）
3. **开始Phase 1**: 项目初始化和环境搭建
4. **TDD开始**: 从第一个测试开始，遵循TDD流程
5. **新增任务**: 
   - Phase 11: 定时任务系统（P0优先级，3-5天）
   - Phase 7.3: 实时推送（P0优先级，1周）

---

## 九、开发进度统计

### 9.1 Phase完成情况

| Phase | 名称 | 状态 | 完成度 |
|-------|------|------|--------|
| Phase 1 | 项目初始化与环境搭建 | ⏳ 待开始 | 0% |
| Phase 2 | 认证系统 | ⏳ 待开始 | 0% |
| Phase 3 | 故事管理模块 | ⏳ 待开始 | 0% |
| Phase 4 | 分支管理模块 | ⏳ 待开始 | 0% |
| Phase 5 | 续写管理模块 | ⏳ 待开始 | 0% |
| Phase 6 | 投票系统 | ⏳ 待开始 | 0% |
| Phase 7 | 通知系统 | ⏳ 待开始 | 0% |
| Phase 8 | 摘要生成 | ⏳ 待开始 | 0% |
| Phase 9 | 评论系统 | ⏳ 待开始 | 0% |
| Phase 10 | 速率限制 | ⏳ 待开始 | 0% |
| Phase 11 | 定时任务系统 | ⏳ 待开始 | 0% |
| Phase 12 | 前端开发 | ⏳ 待开始 | 0% |
| Phase 13 | 测试和优化 | ⏳ 待开始 | 0% |

### 9.2 功能完成情况

#### 核心功能（P0）
- [ ] 故事管理（创建、查看、更新）
- [ ] 分支管理（创建、查看、加入）
- [ ] 续写功能（提交、查看、轮次队列）
- [ ] Bot管理（注册、认证、Webhook）
- [ ] 投票系统（人类投票、Bot投票、权重计算）
- [ ] Webhook通知（轮到续写、新分支）
- [ ] **定时任务系统**（Bot超时检查、活跃度更新）⭐ 新增
- [ ] **实时推送**（前端自动刷新）⭐ 新增

#### 增强功能（P1）
- [ ] 摘要生成（LLM自动生成）
- [ ] 评论系统
- [ ] 速率限制

#### 前端功能
- [ ] 故事列表和详情
- [ ] 分支树展示
- [ ] 续写列表和投票
- [ ] **实时刷新**（新续写、投票更新）⭐ 新增

### 9.3 总体进度

- **总Phase数**: 13个
- **已完成**: 0个
- **进行中**: 0个
- **待开始**: 13个
- **总体完成度**: 0%

### 9.4 里程碑进度

- **里程碑1**: 基础架构搭建 (Week 1) - ⏳ 待开始
- **里程碑2**: 核心功能实现 (Week 2-3) - ⏳ 待开始
- **里程碑3**: 协作机制 (Week 4) - ⏳ 待开始
- **里程碑4**: 增强功能 (Week 5) - ⏳ 待开始
- **里程碑5**: 前端开发 (Week 6) - ⏳ 待开始
- **里程碑6**: 测试和优化 (Week 7) - ⏳ 待开始

---

## 十、参考资料

- TDD最佳实践
- Jest测试框架文档
- Prisma测试指南
- Express.js测试指南
- Vercel Cron文档: https://vercel.com/docs/cron-jobs
- pg_cron文档: https://github.com/citusdata/pg_cron
- Supabase Realtime文档: https://supabase.com/docs/guides/realtime
- node-cron文档: https://github.com/node-cron/node-cron
