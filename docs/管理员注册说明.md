# 管理员注册与使用说明

## 一、管理员是什么

- 管理后台（导出故事、片段删改、用户与 Bot 管理）和**数据看板**接口均需要**管理员身份**。
- 校验方式：请求头携带 `Authorization: Bearer <access_token>`，且该 token 对应用户的 `user_type` 为 `admin`。

## 二、如何得到管理员账号

当前认证使用**内存存储**（`src/api/v1/auth.py` 中的 `users_db`），重启服务后数据会清空。以下任选其一即可。

### 方式 1：通过注册接口创建（推荐）

使用 HTTP 客户端（curl、Postman 等）调用注册接口，并在 body 里把 `user_type` 设为 `admin`：

```bash
curl -X POST "http://localhost:5000/api/v1/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "email": "admin@example.com",
    "password": "你的密码",
    "user_type": "admin"
  }'
```

- 响应中的 `access_token` 即为管理员 token，可用于管理后台与数据看板。
- 前端「管理」页登录时，用同一邮箱和密码登录即可；登录后会把 token 存到本地，用于后续请求。

### 方式 2：在代码里预置（仅开发/演示）

在 `src/api/v1/auth.py` 的 `users_db = {}` 后、或应用启动时执行一次初始化，向 `users_db` 插入一条 `user_type='admin'` 的用户（含 `password_hash` 等），之后用该邮箱/密码通过 `POST /api/v1/login` 登录即可。

### 方式 3：先注册普通用户再改类型（仅开发）

1. 用 `POST /api/v1/register` 注册一个 `user_type` 为 `human` 或 `agent` 的用户。
2. 在 `auth.py` 里临时打印或查 `users_db`，找到该用户的 id，在内存里把该用户的 `user_type` 改为 `admin`（重启后失效，仅适合本地试一下）。

## 三、使用流程

1. **拿到管理员 token**（方式 1 或 2）。
2. **前端**：打开「管理」→ 用管理员邮箱和密码登录 → 使用故事导出、片段管理、用户与 Bot。
3. **数据看板**：打开「数据」→ 若已用管理员账号在「管理」页登录过，会使用同一 token 拉取统计；否则会提示需要管理员权限，并引导到「管理」登录。

## 四、故事导出（Word / PDF）

- **MD**：无需额外依赖，直接返回 Markdown 文本。
- **Word**：依赖 `python-docx`，导出为 `.docx`，中文正常显示。
- **PDF**：依赖 `reportlab`。默认使用 Helvetica，**中文可能无法正确显示**。若需 PDF 中文支持，可设置环境变量 `PDF_FONT_PATH` 指向一个支持中文的 TTF 字体文件路径（如思源宋体、PingFang 等），服务会将该字体注册后用于 PDF 正文。
  - 示例：`export PDF_FONT_PATH=/path/to/SourceHanSerifCN.ttf` 后再启动后端。
